<?php

function islandora_webform_menu() {
  $items['admin/config/islandora_webform/test'] = array(
    'title' => 'Test Page',
    'description' => 'Utility page for testing development work',
    'page callback' => 'islandora_webform_test_page',
    'access arguments' => array('cove admin'),
    'file' => 'test.inc',
    'file path' => drupal_get_path('module', 'islandora_webform') . '/includes',
  );
  $items['node/%webform_menu/webform/islandora'] = array(
    'title' => 'Islandora settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('islandora_webform_configure_form', 1),
    'access callback' => 'node_access',
    'access arguments' => array('update', 1),
    'file' => 'includes/webform.configure.inc',
    'weight' => 5,
    'type' => MENU_LOCAL_TASK,
  );
  $items['islandora_webform/%/tag_object/%'] = array(
    'page callback' => 'islandora_webform_action_tag_object',
    'page arguments' => array(1, 3),
    'access callback' => '_islandora_webform_user_access_or',
    'access arguments' => array('manage islandora webform', 'islandora webform link objects'),
    'type' => MENU_CALLBACK,
    'file' => 'tag_object.inc',
    'file path' => drupal_get_path('module', 'islandora_webform') . '/includes',
  );
  $items['islandora_webform/%/untag_object/%'] = array(
    'page callback' => 'islandora_webform_action_untag_object',
    'page arguments' => array(1, 3),
    'access callback' => '_islandora_webform_user_access_or',
    'access arguments' => array('manage islandora webform', 'islandora webform link objects'),
    'type' => MENU_CALLBACK,
    'file' => 'tag_object.inc',
    'file path' => drupal_get_path('module', 'islandora_webform') . '/includes',
  );

  return $items;
}

/**
 *  Implements hook_permission().
 */
function islandora_webform_permission() {
  return array(
    'manage islandora webform' => array(
      'title' => t('Manage Islandora Webforms'),
      'description' => t('Manage islandora settings on webforms.'),
    ),
    'islandora webform link objects' => array(
      'title' => t('Link islandora objects to webforms'),
      'description' => t('Permission to link individual islandora objects to webforms'),
    ),
  );
}

function islandora_webform_preprocess_islandora_basic_image(&$variables) {
  module_load_include('inc', 'islandora_webform', 'includes/theme');
  islandora_webform_preprocess_solution_pack_module($variables);
}

/**
 * Utility functions
 */

/**
 * Return user access = TRUE if user access for any listed permission is true
 *
 * @param $permissions
 *   array of permission strings
 *
 * @return bool
 *   TRUE if user access granted
 *   FALSE if user access denied
 */
function _islandora_webform_user_access_or($permissions) {
  global $user;
  if ($user->uid == 1) {
    return TRUE;
  }
  $permissions = (array) $permissions;
  foreach ($permissions as $permission) {
    if (user_access($permission)) {
      return TRUE;
    }
  }
  return FALSE;
}